# rapor_ekrani.py
from kivymd.uix.screen import MDScreen
from kivy.uix.boxlayout import BoxLayout

# Grafik için
from kivy.garden.matplotlib.backend_kivyagg import FigureCanvasKivyAgg
import matplotlib.pyplot as plt

import sqlite3


class RaporEkrani(MDScreen):
    def on_enter(self):
        # Ekran açılır açılmaz grafiği çiz
        self.ciz_grafik()

    def verileri_al(self):
        """SQLite veritabanından T3 ve T4 verilerini alır."""
        baglanti = sqlite3.connect("tiroid_takip.db")  # ← GÜNCELLENDİ
        imlec = baglanti.cursor()

        imlec.execute("SELECT tarih, t3, t4 FROM tahliller")
        veriler = imlec.fetchall()

        baglanti.close()
        return veriler

    def ciz_grafik(self):
        veriler = self.verileri_al()

        # Boş veri kontrolü
        if len(veriler) == 0:
            print("Hiç veri yok!")
            return

        # Tarih, t3, t4 değerlerini ayır
        tarih_listesi = []
        t3_listesi = []
        t4_listesi = []

        for veri in veriler:
            tarih_listesi.append(veri[0])
            t3_listesi.append(veri[1])
            t4_listesi.append(veri[2])

        # Grafik çizimi
        plt.clf()
        fig, ax = plt.subplots()

        ax.plot(tarih_listesi, t3_listesi, label="T3", color="purple")
        ax.plot(tarih_listesi, t4_listesi, label="T4", color="blue")

        ax.set_title("T3 - T4 Hormon Değerleri")
        ax.set_xlabel("Tarih")
        ax.set_ylabel("Hormon Seviyesi")
        ax.legend()

        # Grafiği ekranın içine ekle
        kutu = BoxLayout()
        kutu.add_widget(FigureCanvasKivyAgg(fig))

        # Ekrana ekle
        self.add_widget(kutu)
